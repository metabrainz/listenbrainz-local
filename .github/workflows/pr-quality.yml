name: PR Quality Check

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  quality-check:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
        # Install additional tools for quality checks
        pip install black isort mypy bandit[toml] types-requests

    - name: Check code formatting with Black
      run: |
        black --check --diff lb_local/ tests/ || echo "âš ï¸ Code formatting issues found (not blocking)"

    - name: Check import sorting with isort
      run: |
        isort --check-only --diff lb_local/ tests/ || echo "âš ï¸ Import sorting issues found (not blocking)"

    - name: Run security check with bandit
      run: |
        bandit -r lb_local/ -f json -o bandit-report.json || echo "âš ï¸ Security issues found (advisory)"

    - name: Run type checking with mypy
      run: |
        mypy lb_local/ --ignore-missing-imports --no-strict-optional || echo "âš ï¸ Type checking issues found (advisory)"

    - name: Check for common issues
      run: |
        echo "ðŸ” Checking for common issues..."
        
        # Check for TODO/FIXME comments
        echo "ðŸ“ TODO/FIXME comments found:"
        grep -r "TODO\|FIXME" lb_local/ tests/ || echo "None found"
        
        # Check for print statements (should use logging)
        echo "ðŸ–¨ï¸  Print statements found (consider using logging):"
        grep -r "print(" lb_local/ || echo "None found"
        
        # Check for hardcoded secrets/passwords
        echo "ðŸ” Checking for potential hardcoded secrets:"
        grep -ri "password\|secret\|key" lb_local/ --include="*.py" | grep -v "# noqa" || echo "None found"

    - name: Run fast test suite
      run: |
        python run_tests.py --no-cov -x tests/test_framework_validation.py

    - name: Check test coverage requirements
      run: |
        python run_tests.py --cov=lb_local --cov-report=term --cov-fail-under=70 || echo "âš ï¸ Coverage below 70% (advisory for now)"

    - name: Validate documentation
      run: |
        echo "ðŸ“š Checking documentation completeness..."
        
        # Check if new endpoints have documentation
        if git diff --name-only origin/main...HEAD | grep -q "lb_local/view/"; then
          echo "âœ… View files changed - ensure endpoints are documented in TESTING.md"
        fi
        
        # Check for README updates if significant changes
        if [[ $(git diff --stat origin/main...HEAD | tail -n1 | grep -o '[0-9]\+' | head -n1) -gt 50 ]]; then
          echo "ðŸ“ Large changeset detected - consider updating README.md"
        fi

    - name: Performance check
      run: |
        echo "âš¡ Running performance checks..."
        time python run_tests.py tests/test_framework_validation.py > /dev/null
        echo "âœ… Test suite performance check completed"
